{"version":3,"sources":["ajax_comments.es6"],"names":["DjangoAjaxCommentsXtd","options","defaultOptions","commentFormClass","commentItemWrapperSelector","commentsWrapperSelector","replyLinkClass","listenToReplyClicks","submitFormWithAjax","replyUrlAsAttr","opts","Object","assign","document","addEventListener","e","target","classList","value","split","indexOf","preventDefault","reply","contains","submit","el","replyForm","parentNode","querySelector","ajaxGet","href","getAttribute","parser","DOMParser","responsedDom","parseFromString","resp","responseText","insertAfter","remove","submittedForm","replyTo","ajaxPost","id","responseDom","responseForm","getElementById","responseComment","outerHTML","innerHTML","url","callback","xhr","XMLHttpRequest","open","setRequestHeader","onload","bind","send","form","action","csrftoken","getCookie","formData","FormData","referenceNode","insertBefore","nextSibling","removeChild","name","cookie","parts","length","pop","shift","django_ajax_comments_xtd","watch"],"mappings":";;;;;;IAAMA,qB;AAEJ,iCAAYC,OAAZ,EAAqB;AAAA;;AACnB,QAAMC,iBAAiB;AACrBC,wBAAkB,qBADG;AAErBC,kCAA4B,uBAFP;AAGrBC,+BAAyB,WAHJ;AAIrBC,sBAAgB,YAJK;AAKrBC,2BAAqB,IALA;AAMrBC,0BAAoB,IANC;AAOrBC,sBAAgB;AAPK,KAAvB;AASA,SAAKC,IAAL,GAAYC,OAAOC,MAAP,CAAcV,cAAd,EAA8BD,OAA9B,CAAZ;AACD;;;;4BAEO;AAAA;;AACN,UAAI,KAAKS,IAAL,CAAUH,mBAAd,EAAmC;AACjCM,iBAASC,gBAAT,CAA0B,OAA1B,EAAmC,aAAK;AACtC,cAAIC,EAAEC,MAAF,CAASC,SAAT,CAAmBC,KAAnB,CAAyBC,KAAzB,CAA+B,GAA/B,EAAoCC,OAApC,CAA4C,MAAKV,IAAL,CAAUJ,cAAtD,IAAwE,CAAC,CAA7E,EAAgF;AAC9ES,cAAEM,cAAF;AACA,kBAAKC,KAAL,CAAWP,EAAEC,MAAb;AACD;AACF,SALD;AAMD;AACD,UAAI,KAAKN,IAAL,CAAUF,kBAAd,EAAkC;AAChCK,iBAASC,gBAAT,CAA0B,QAA1B,EAAoC,aAAK;AACvC,cAAIC,EAAEC,MAAF,CAASC,SAAT,CAAmBM,QAAnB,CAA4B,MAAKb,IAAL,CAAUP,gBAAtC,CAAJ,EAA6D;AAC3DY,cAAEM,cAAF;AACA,kBAAKG,MAAL,CAAYT,EAAEC,MAAd;AACD;AACF,SALD;AAMD;AACF;;;0BAEKS,E,EAAI;AAAA;;AACR,UAAIC,YAAYD,GAAGE,UAAH,CAAcA,UAAd,CAAyBC,aAAzB,CAAuC,MAAM,KAAKlB,IAAL,CAAUP,gBAAvD,CAAhB;AACA,UAAI,CAACuB,SAAL,EAAgB;AACd,aAAKG,OAAL,CACEJ,GAAGK,IAAH,IAAWL,GAAGM,YAAH,CAAgB,WAAhB,CADb,EAEE,gBAAQ;AACN,cAAIC,SAAS,IAAIC,SAAJ,EAAb;AAAA,cACIC,eAAeF,OAAOG,eAAP,CAAuBC,KAAKpB,MAAL,CAAYqB,YAAnC,EAAiD,WAAjD,CADnB;AAAA,cAEIX,YAAYQ,aAAaN,aAAb,CAA2B,MAA3B,CAFhB;AAGA,iBAAKU,WAAL,CAAiBZ,SAAjB,EAA4BD,GAAGE,UAA/B;AACD,SAPH;AASD,OAVD,MAWK;AACH,aAAKY,MAAL,CAAYb,SAAZ,EAAuBD,GAAGE,UAAH,CAAcA,UAArC;AACD;AACF;;;2BAEMF,E,EAAI;AAAA;;AACT,UAAIe,gBAAgBf,EAApB;AAAA,UACIgB,UAAUD,cAAcT,YAAd,CAA2B,eAA3B,CADd;AAEA,WAAKW,QAAL,CAAcF,aAAd,EAA6B,gBAAQ;AACnC,YAAIA,cAAcG,EAAlB,EAAsB;AACpB,cAAIX,SAAS,IAAIC,SAAJ,EAAb;AAAA,cACEW,cAAcZ,OAAOG,eAAP,CAAuBC,KAAKpB,MAAL,CAAYqB,YAAnC,EAAiD,WAAjD,CADhB;AAAA,cAEEQ,eAAeD,YAAYE,cAAZ,CAA2BN,cAAcG,EAAzC,CAFjB;AAAA,cAGEI,kBAAkBH,YAAYhB,aAAZ,CAA0B,OAAKlB,IAAL,CAAUN,0BAApC,CAHpB;AAIA,cAAIqC,OAAJ,EAAa;AACX,gBAAIM,eAAJ,EAAqB;AACnBP,4BAAcQ,SAAd,GAA0BD,gBAAgBC,SAA1C;AACD,aAFD,MAGK;AACHR,4BAAcQ,SAAd,GAA0BH,aAAaG,SAAvC;AACD;AACF,WAPD,MAQK;AACHR,0BAAcQ,SAAd,GAA0BH,aAAaG,SAAvC;AACAnC,qBAASe,aAAT,CAAuB,OAAKlB,IAAL,CAAUL,uBAAjC,EAA0D4C,SAA1D,IAAuEF,gBAAgBE,SAAvF;AACD;AACF,SAjBD,MAkBK;AACHT,wBAAcS,SAAd,GAA0Bb,KAAKpB,MAAL,CAAYqB,YAAtC;AACD;AACF,OAtBD;AAuBD;;;4BAEOa,G,EAAKC,Q,EAAU;AACrB,UAAMC,MAAM,IAAIC,cAAJ,EAAZ;AACAD,UAAIE,IAAJ,CAAS,KAAT,EAAgBJ,GAAhB;AACAE,UAAIG,gBAAJ,CAAqB,kBAArB,EAAyC,gBAAzC;AACAH,UAAII,MAAJ,GAAaL,SAASM,IAAT,CAAcL,GAAd,CAAb;AACAA,UAAIM,IAAJ;AACD;;;6BAEQC,I,EAAMR,Q,EAAU;AACvB,UAAMD,MAAMS,KAAKC,MAAjB;AAAA,UACER,MAAM,IAAIC,cAAJ,EADR;AAAA,UAEEQ,YAAY,KAAKC,SAAL,CAAe,WAAf,CAFd;AAAA,UAGEC,WAAW,IAAIC,QAAJ,CAAaL,IAAb,CAHb;;AAKAP,UAAIE,IAAJ,CAAS,MAAT,EAAiBJ,GAAjB;AACAE,UAAIG,gBAAJ,CAAqB,aAArB,EAAoCM,SAApC;AACAT,UAAIG,gBAAJ,CAAqB,kBAArB,EAAyC,gBAAzC;;AAEA;AACAH,UAAII,MAAJ,GAAaL,SAASM,IAAT,CAAcL,GAAd,CAAb;;AAEA;AACAA,UAAIM,IAAJ,CAASK,QAAT;AACD;;;gCAEYtC,E,EAAIwC,a,EAAe;AAC9BA,oBAActC,UAAd,CAAyBuC,YAAzB,CAAsCzC,EAAtC,EAA0CwC,cAAcE,WAAxD;AACD;;;iCAEa1C,E,EAAIwC,a,EAAe;AAC/BA,oBAActC,UAAd,CAAyBuC,YAAzB,CAAsCzC,EAAtC,EAA0CwC,aAA1C;AACD;;;2BAEOxC,E,EAAIwC,a,EAAe;AACzBA,oBAAcG,WAAd,CAA0B3C,EAA1B;AACD;;;8BAEU4C,I,EAAM;AACf,UAAInD,QAAQ,OAAOL,SAASyD,MAA5B;AACA,UAAIC,QAAQrD,MAAMC,KAAN,CAAY,OAAOkD,IAAP,GAAc,GAA1B,CAAZ;AACA,aAAOE,MAAMC,MAAN,KAAiB,CAAjB,GAAqBD,MAAME,GAAN,GAAYtD,KAAZ,CAAkB,GAAlB,EAAuBuD,KAAvB,EAArB,GAAsD,IAA7D;AACD;;;;;;AAIH,IAAMC,2BAA2B,IAAI3E,qBAAJ,EAAjC;AACA2E,yBAAyBC,KAAzB","file":"ajax_comments.js","sourcesContent":["class DjangoAjaxCommentsXtd {\n\n  constructor(options) {\n    const defaultOptions = {\n      commentFormClass: 'comment-submit-form',\n      commentItemWrapperSelector: '.comment-item-wrapper',\n      commentsWrapperSelector: '#comments',\n      replyLinkClass: 'reply-link',\n      listenToReplyClicks: true,\n      submitFormWithAjax: true,\n      replyUrlAsAttr: true\n    };\n    this.opts = Object.assign(defaultOptions, options);\n  }\n\n  watch() {\n    if (this.opts.listenToReplyClicks) {\n      document.addEventListener('click', e => {\n        if (e.target.classList.value.split(' ').indexOf(this.opts.replyLinkClass) > -1) {\n          e.preventDefault();\n          this.reply(e.target);\n        }\n      });\n    }\n    if (this.opts.submitFormWithAjax) {\n      document.addEventListener('submit', e => {\n        if (e.target.classList.contains(this.opts.commentFormClass)) {\n          e.preventDefault();\n          this.submit(e.target);\n        }\n      });\n    }\n  }\n\n  reply(el) {\n    let replyForm = el.parentNode.parentNode.querySelector('.' + this.opts.commentFormClass);\n    if (!replyForm) {\n      this.ajaxGet(\n        el.href || el.getAttribute('data-href'),\n        resp => {\n          let parser = new DOMParser(),\n              responsedDom = parser.parseFromString(resp.target.responseText, \"text/html\"),\n              replyForm = responsedDom.querySelector('form');\n          this.insertAfter(replyForm, el.parentNode);\n        }\n      );\n    }\n    else {\n      this.remove(replyForm, el.parentNode.parentNode);\n    }\n  }\n\n  submit(el) {\n    let submittedForm = el,\n        replyTo = submittedForm.getAttribute('data-reply-to');\n    this.ajaxPost(submittedForm, resp => {\n      if (submittedForm.id) {\n        let parser = new DOMParser(),\n          responseDom = parser.parseFromString(resp.target.responseText, \"text/html\"),\n          responseForm = responseDom.getElementById(submittedForm.id),\n          responseComment = responseDom.querySelector(this.opts.commentItemWrapperSelector);\n        if (replyTo) {\n          if (responseComment) {\n            submittedForm.outerHTML = responseComment.outerHTML;\n          }\n          else {\n            submittedForm.outerHTML = responseForm.outerHTML;\n          }\n        }\n        else {\n          submittedForm.outerHTML = responseForm.outerHTML;\n          document.querySelector(this.opts.commentsWrapperSelector).innerHTML += responseComment.innerHTML;\n        }\n      }\n      else {\n        submittedForm.innerHTML = resp.target.responseText;\n      }\n    });\n  }\n\n  ajaxGet(url, callback) {\n    const xhr = new XMLHttpRequest();\n    xhr.open(\"GET\", url);\n    xhr.setRequestHeader(\"X-Requested-With\", 'XMLHttpRequest');\n    xhr.onload = callback.bind(xhr);\n    xhr.send();\n  }\n\n  ajaxPost(form, callback) {\n    const url = form.action,\n      xhr = new XMLHttpRequest(),\n      csrftoken = this.getCookie('csrftoken'),\n      formData = new FormData(form);\n\n    xhr.open(\"POST\", url);\n    xhr.setRequestHeader(\"X-CSRFToken\", csrftoken);\n    xhr.setRequestHeader(\"X-Requested-With\", 'XMLHttpRequest');\n\n    //.bind ensures that this inside of the function is the XHR object.\n    xhr.onload = callback.bind(xhr);\n\n    //All preperations are clear, send the request!\n    xhr.send(formData);\n  }\n\n  insertAfter (el, referenceNode) {\n    referenceNode.parentNode.insertBefore(el, referenceNode.nextSibling);\n  }\n\n  insertBefore (el, referenceNode) {\n    referenceNode.parentNode.insertBefore(el, referenceNode);\n  }\n\n  remove (el, referenceNode) {\n    referenceNode.removeChild(el);\n  }\n\n  getCookie (name) {\n    let value = \"; \" + document.cookie;\n    let parts = value.split(\"; \" + name + \"=\");\n    return parts.length === 2 ? parts.pop().split(\";\").shift() : null;\n  }\n\n}\n\nconst django_ajax_comments_xtd = new DjangoAjaxCommentsXtd();\ndjango_ajax_comments_xtd.watch();\n"]}